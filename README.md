## 项目简介

**godelayq** 是一个生产级的 Go 语言延迟任务调度系统，采用四叉堆（4-ary Heap）作为核心数据结构，相比传统二叉堆具有更好的 CPU 缓存局部性。设计灵感来源于 Go 标准库 `time` 包的定时器实现。

### 为什么选择四叉堆？

| 特性 | 二叉堆 | 四叉堆 |
|------|--------|--------|
| 层数 | 高 | 低（减少约50%） |
| 缓存命中率 | 一般 | 更高 |
| 父子节点距离 | 远 | 近 |
| 适合场景 | 通用 | 高频调度 |

### 适用场景

- 🛒 **电商系统**：订单超时取消、延迟支付检查、库存回滚
- 📧 **消息推送**：定时邮件、短信、App 推送
- 📊 **数据处理**：定时报表生成、数据同步、日志清理
- 🔄 **工作流引擎**：状态机流转、审批超时提醒
- ⏰ **定时任务**：Cron 表达式支持的周期性任务


## 架构设计

### 架构设计图

```shell
┌─────────────────────────────────────────────────────────────────┐
│                         API Gateway (Gin)                        │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐  │
│  │  REST API   │  │  WebSocket  │  │  SSE (Server-Sent Events)│  │
│  │  /api/v1/*  │  │  /ws        │  │  /sse/events            │  │
│  └──────┬──────┘  └──────┬──────┘  └───────────┬─────────────┘  │
└─────────┼────────────────┼─────────────────────┼────────────────┘
│                │                     │
└────────────────┴─────────────────────┘
│
▼
┌─────────────────────────────────────────────────────────────────┐
│                      Scheduler Core (调度器核心)                  │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────┐  │
│  │  QuaternaryHeap │◄───│  Job Registry   │    │  EventBus   │  │
│  │  (四叉堆)        │    │  (任务注册表)    │    │  (事件总线)  │  │
│  │                 │    │                 │    │             │  │
│  │  • Push O(log n)│    │  • Handler管理   │    │  • Pub/Sub  │  │
│  │  • Pop  O(log n)│    │  • 动态注册      │    │  • 实时推送  │  │
│  │  • Remove O(log)│    │  • 类型安全      │    │  • 过滤订阅  │  │
│  └─────────────────┘    └─────────────────┘    └──────┬──────┘  │
└───────────────────────────────────────────────────────┼─────────┘
│
┌──────────────────┬──────────────────────────┤
│                  │                          │
▼                  ▼                          ▼
┌─────────────────┐  ┌─────────────────┐    ┌─────────────────────┐
│   Retry Policy  │  │   Cron Parser   │    │   Directory Loader  │
│  (重试策略)      │  │  (robfig/cron)  │    │   (文件任务加载器)   │
│                 │  │                 │    │                     │
│  • 指数退避      │  │  • 标准Cron     │    │  • 目录监控          │
│  • 固定间隔      │  │  • 秒级精度      │    │  • JSON任务文件      │
│  • 最大重试限制  │  │  • 下次执行计算  │    │  • 自动加载/归档     │
└─────────────────┘  └─────────────────┘    └─────────────────────┘
│                  │                          │
└──────────────────┴──────────────────────────┘
│
▼
┌─────────────────────────────────────────────────────────────────┐
│                      Persistence Layer (持久化层)                 │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │
│  │  JSON File Store│  │  (可扩展: Redis) │  │  (可扩展: MySQL) │  │
│  │  • 原子写入      │  │  • 分布式锁      │  │  • 事务支持      │  │
│  │  • 崩溃恢复      │  │  • 集群支持      │  │  • 复杂查询      │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

### 数据流图

```shell

[任务提交] ──► [API/文件/程序] ──► [四叉堆调度] ──► [时间到达] ──► [执行Handler]
│                │                  │              │
│                │                  ▼              ▼
│                │           [持久化存储]    [事件总线] ──► [WebSocket推送]
│                │                  │              │
│                └──────────────────┘              ▼
│                                         [重试/Cron/归档]
▼
[立即返回任务ID]
```

### 核心文件详解

| 文件 | 作用 | 关键设计 |
|------|------|----------|
| `heap.go` | 四叉堆实现 | 索引映射实现 O(1) 查找，支持并发安全操作 |
| `scheduler.go` | 调度器引擎 | 时间轮询优化，避免忙等待，支持优雅关闭 |
| `event.go` | 事件驱动架构 | 发布-订阅模式，支持多路复用和背压处理 |
| `websocket.go` | 实时通信 | 心跳保活、过滤订阅、自动重连支持 |
| `load.go` | 文件任务加载 | fsnotify 实时监控，支持原子移动和错误隔离 |

---

## 核心特性

### 1. 高性能调度

- **四叉堆数据结构**：比二叉堆减少约 50% 的层级，提升缓存命中率
- **O(log n) 操作复杂度**：插入、删除、更新均为对数时间
- **无锁设计**：读多写少场景使用 RWMutex，高并发优化

### 2. 可靠性保障

- **持久化存储**：JSON 文件原子写入，崩溃后自动恢复
- **至少一次执行**：失败自动重试，支持指数退避和最大重试限制
- **优雅关闭**：SIGTERM 信号处理，等待正在执行的任务完成

### 3. 灵活的任务定义

- **多种触发方式**：延迟执行（Duration）、定时执行（Time）、周期执行（Cron）
- **动态注册**：运行时注册任务处理器，支持热更新
- **上下文传递**：支持 cancellation 和 timeout

### 4. 实时可观测性

- **WebSocket 推送**：任务状态变更实时推送到前端
- **SSE 备选方案**：兼容不支持 WebSocket 的客户端
- **REST API 查询**：完整的任务生命周期管理接口
- **监控面板**：内置 Web Dashboard

### 5. 扩展能力

- **存储插件化**：接口设计支持 Redis、MySQL 等扩展
- **任务文件化**：支持通过文件系统提交任务，便于 CI/CD 集成

---

## 快速开始

### 环境要求

- Go 1.21+
- Linux/macOS/Windows

### 安装

```bash
# 克隆项目
git clone https://github.com/jiujuan/godelayq.git
cd godelayq

# 下载依赖
go mod download

# 编译
go build -o godelayq-server ./cmd/server

# 运行
./godelayq-server
```

### Docker 部署

```bash
# 构建镜像
docker build -t godelayq:latest .

# 运行容器
docker run -d \
  -p 8080:8080 \
  -v /data/godelayq:/app/data \
  -e TZ=Asia/Shanghai \
  --name godelayq \
  godelayq:latest
```

## 其它文档

- [API文档](./docs/api.md)
- [架构文档](./docs/architecture.md)
- [例子](./docs/example.md)
- [部署文档](./docs/deployment.md)