<!DOCTYPE html>
<html>
<head>
    <title>Goschedjob å®æ—¶ç›‘æ§</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f0f0f0; }
        #status { display: flex; gap: 20px; margin-bottom: 20px; }
        .stat-box { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        #events { background: white; padding: 20px; border-radius: 8px; height: 500px; overflow-y: auto; }
        .event { padding: 10px; margin: 5px 0; border-left: 4px solid #ccc; background: #f9f9f9; }
        .event.scheduled { border-color: #3498db; }
        .event.started { border-color: #f39c12; }
        .event.completed { border-color: #27ae60; }
        .event.failed { border-color: #e74c3c; }
        .event.cancelled { border-color: #95a5a6; }
        .timestamp { color: #7f8c8d; font-size: 12px; }
    </style>
</head>
<body>
    <h1>ğŸš€ Goschedjob å®æ—¶ç›‘æ§é¢æ¿</h1>
    
    <div id="status">
        <div class="stat-box">
            <h3>WebSocket çŠ¶æ€</h3>
            <p id="ws-status">Disconnected</p>
        </div>
        <div class="stat-box">
            <h3>å¾…å¤„ç†ä»»åŠ¡</h3>
            <p id="pending-count">0</p>
        </div>
        <div class="stat-box">
            <h3>è¿è¡Œä¸­</h3>
            <p id="running-count">0</p>
        </div>
    </div>
    
    <div>
        <h3>è¿‡æ»¤æ¡ä»¶ï¼š</h3>
        <label><input type="checkbox" class="filter" value="job.scheduled" checked> å·²è°ƒåº¦</label>
        <label><input type="checkbox" class="filter" value="job.started" checked> å¼€å§‹</label>
        <label><input type="checkbox" class="filter" value="job.completed" checked> å®Œæˆ</label>
        <label><input type="checkbox" class="filter" value="job.failed" checked> å¤±è´¥</label>
    </div>
    
    <div id="events"></div>

    <script>
        const ws = new WebSocket('ws://localhost:8080/ws');
        const eventsDiv = document.getElementById('events');
        
        ws.onopen = () => {
            document.getElementById('ws-status').textContent = 'Connected';
            document.getElementById('ws-status').style.color = 'green';
            
            // å‘é€è®¢é˜…æ¶ˆæ¯ï¼ˆå…³æ³¨ payment_check ç±»å‹ä»»åŠ¡ï¼‰
            ws.send(JSON.stringify({
                action: 'subscribe',
                filter: {
                    job_types: ['payment_check', 'email_send'],
                    event_types: ['job.scheduled', 'job.started', 'job.completed', 'job.failed']
                }
            }));
        };
        
        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);
            console.log('Received:', data);
            
            // åˆ›å»ºäº‹ä»¶å¡ç‰‡
            const div = document.createElement('div');
            div.className = `event ${data.type.replace('job.', '')}`;
            
            const time = new Date(data.timestamp).toLocaleTimeString();
            div.innerHTML = `
                <div class="timestamp">${time}</div>
                <strong>[${data.type}]</strong> ${data.job_name} 
                (ID: ${data.job_id.substring(0, 8)}...)
                ${data.metadata ? `<pre>${JSON.stringify(data.metadata, null, 2)}</pre>` : ''}
            `;
            
            eventsDiv.insertBefore(div, eventsDiv.firstChild);
            
            // é™åˆ¶æ˜¾ç¤ºæ•°é‡
            if (eventsDiv.children.length > 100) {
                eventsDiv.removeChild(eventsDiv.lastChild);
            }
            
            // æ›´æ–°ç»Ÿè®¡ï¼ˆå®é™…åº”ä»stats APIè·å–ï¼‰
            updateStats(data);
        };
        
        ws.onclose = () => {
            document.getElementById('ws-status').textContent = 'Disconnected';
            document.getElementById('ws-status').style.color = 'red';
        };
        
        // å¿ƒè·³ä¿æ´»
        setInterval(() => {
            if (ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({action: 'ping'}));
            }
        }, 30000);
        
        function updateStats(event) {
            // ç®€åŒ–ç»Ÿè®¡é€»è¾‘
            if (event.type === 'job.scheduled') {
                const el = document.getElementById('pending-count');
                el.textContent = parseInt(el.textContent) + 1;
            }
        }
        
        // å®¢æˆ·ç«¯è¿‡æ»¤ï¼ˆæ ¹æ®å¤é€‰æ¡†ï¼‰
        document.querySelectorAll('.filter').forEach(cb => {
            cb.addEventListener('change', () => {
                const selected = Array.from(document.querySelectorAll('.filter:checked')).map(c => c.value);
                ws.send(JSON.stringify({
                    action: 'subscribe',
                    filter: { event_types: selected }
                }));
            });
        });
    </script>
</body>
</html>